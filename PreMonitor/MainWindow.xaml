<Window x:Class="PreMonitor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:PreMonitor"
    xmlns:converters="clr-namespace:PreMonitor.Converters"
        mc:Ignorable="d"
        Title="{Binding WindowTitle}" 
        Height="600" 
        Width="800"
        MinHeight="400"
        MinWidth="600"
        WindowStartupLocation="CenterScreen">
    
    <Window.Resources>
        <converters:EnumToBooleanConverter x:Key="EnumToBooleanConverter"/>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 菜单栏 -->
        <Menu Grid.Row="0" Style="{StaticResource MenuBarStyle}">
            <MenuItem Header="关于(_A)" Command="{Binding AboutCommand}"/>
        </Menu>
        
        <!-- 主内容区域 -->
        <Grid Grid.Row="1" Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- 左侧面板 -->
            <Border Grid.Column="0" Style="{StaticResource PanelBorderStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" 
                              Text="监控面板" 
                              Style="{StaticResource PanelHeaderStyle}"/>
                    
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="5">
                            <TextBlock Text="{Binding IsMonitoring, StringFormat='监控状态: {0}', Converter={StaticResource BooleanToStringConverter}}" 
                                      Margin="0,5" 
                                      FontWeight="Bold"/>
                            
                            <Button Content="开始监控" 
                                   Command="{Binding StartMonitoringCommand}"
                                   Style="{StaticResource PrimaryButtonStyle}"
                                   Margin="0,5"
                                   IsEnabled="{Binding IsMonitoring, Converter={StaticResource InverseBooleanConverter}}"/>
                            
                            <Button Content="停止监控" 
                                   Command="{Binding StopMonitoringCommand}"
                                   Style="{StaticResource SecondaryButtonStyle}"
                                   Margin="0,5"
                                   IsEnabled="{Binding IsMonitoring}"/>
                            
                            <Separator Margin="0,10"/>
                            
                            <TextBlock Text="调试功能" FontWeight="Bold" Margin="0,5"/>
                            
                            <Button Content="测试检测" 
                                   Command="{Binding TestEdgeDetectionCommand}"
                                   Style="{StaticResource SecondaryButtonStyle}"
                                   Margin="0,2"/>
                            
                            <Button Content="强制终止（当前目标）" 
                                   Command="{Binding ForceKillEdgeCommand}"
                                   Style="{StaticResource SecondaryButtonStyle}"
                                   Margin="0,2"/>
                            
                            <Button Content="检查管理员权限" 
                                   Command="{Binding CheckAdminCommand}"
                                   Style="{StaticResource SecondaryButtonStyle}"
                                   Margin="0,2"/>
                            
                            <Button Content="清除日志" 
                                   Command="{Binding ClearLogsCommand}"
                                   Style="{StaticResource SecondaryButtonStyle}"
                                   Margin="0,2"/>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>
            
            <!-- 分隔符 -->
            <GridSplitter Grid.Column="1" 
                         HorizontalAlignment="Stretch" 
                         VerticalAlignment="Stretch"
                         Background="LightGray"/>
            
            <!-- 主内容区 -->
            <Border Grid.Column="2" Style="{StaticResource PanelBorderStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" 
                              Text="监控信息" 
                              Style="{StaticResource PanelHeaderStyle}"/>
                    
                    <TabControl x:Name="MainTabs" Grid.Row="1" Margin="5" SelectionChanged="MainTabs_SelectionChanged">
                        <TabItem Header="实时数据">
                            <TextBox Text="{Binding MonitorData, Mode=OneWay}"
                                    IsReadOnly="True"
                                    TextWrapping="Wrap"
                                    VerticalScrollBarVisibility="Auto"
                                    Style="{StaticResource LogTextBoxStyle}"/>
                        </TabItem>
                        <TabItem Header="日志">
                            <TextBox Text="{Binding LogData, Mode=OneWay}"
                                    IsReadOnly="True"
                                    TextWrapping="Wrap"
                                    VerticalScrollBarVisibility="Auto"
                                    Style="{StaticResource LogTextBoxStyle}"/>
                        </TabItem>
                        <TabItem Header="设置">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel Margin="10">
                                    <TextBlock Text="监控间隔 (秒):" Margin="0,5"/>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBox Text="{Binding MonitorInterval, UpdateSourceTrigger=PropertyChanged}" 
                                                Width="100" 
                                                HorizontalAlignment="Left"
                                                Margin="0,5"/>
                                        <TextBlock Text="(范围: 1-3600)" 
                                                  Margin="10,5,0,5" 
                                                  FontSize="10" 
                                                  Foreground="Gray" 
                                                  VerticalAlignment="Center"/>
                                    </StackPanel>
                                    
                                    <CheckBox Content="启用自动保存" 
                                             IsChecked="{Binding AutoSaveEnabled}"
                                             Margin="0,10"/>
                                    
                                    <TextBlock Text="启动设置" FontWeight="Bold" Margin="0,15,0,5"/>
                                    
                                    <CheckBox Content="开机自启动" 
                                             IsChecked="{Binding IsStartupEnabled}"
                                             Margin="0,5"/>
                                    <TextBlock Text="启用后将在系统启动时自动运行 PreMonitor" 
                                              Margin="20,0,0,10" 
                                              FontSize="10" 
                                              Foreground="Gray" 
                                              TextWrapping="Wrap"/>
                                    
                                    <CheckBox Content="开机后自动在托盘监测" 
                                             IsChecked="{Binding IsTrayMonitorStartupEnabled}"
                                             Margin="0,5"/>
                                    <TextBlock Text="启用后将在系统启动时自动在托盘运行并开始监测，不显示主窗口（PreMonitor）" 
                                              Margin="20,0,0,10" 
                                              FontSize="10" 
                                              Foreground="Gray" 
                                              TextWrapping="Wrap"/>
                                    
                                    <TextBlock Text="窗口关闭行为" FontWeight="Bold" Margin="0,15,0,5"/>
                                    
                                    <TextBlock Text="点击关闭按钮时默认的操作:" Margin="0,5"/>
                                    <StackPanel Margin="20,5">
                                        <RadioButton Content="关闭 PreMonitor" 
                                                    IsChecked="{Binding CloseAction, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=Exit}"
                                                    GroupName="CloseAction"
                                                    Margin="0,3"/>
                                        <RadioButton Content="最小化到托盘" 
                                                    IsChecked="{Binding CloseAction, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=MinimizeToTray}"
                                                    GroupName="CloseAction"
                                                    Margin="0,3"/>
                                        <RadioButton Content="每次询问" 
                                                    IsChecked="{Binding CloseAction, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=Ask}"
                                                    GroupName="CloseAction"
                                                    Margin="0,3"/>
                                    </StackPanel>
                                    
                                    <Button Content="重置关闭选择" 
                                           Command="{Binding ResetCloseChoiceCommand}"
                                           Style="{StaticResource SecondaryButtonStyle}"
                                           HorizontalAlignment="Left"
                                           Margin="0,10"/>
                                    
                                    <TextBlock Text="日志管理" FontWeight="Bold" Margin="0,15,0,5"/>
                                    
                                    <StackPanel Orientation="Horizontal" Margin="0,5">
                                        <Button Content="查看日志统计" 
                                               Command="{Binding ViewLogStatsCommand}"
                                               Style="{StaticResource SecondaryButtonStyle}"
                                               Margin="0,0,10,0"/>
                                        <Button Content="打开日志文件夹" 
                                               Command="{Binding OpenLogFolderCommand}"
                                               Style="{StaticResource SecondaryButtonStyle}"/>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </TabItem>
                        <TabItem Header="受监控应用">
                            <Grid Margin="10">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,8">
                                    <Button Content="添加规则" Command="{Binding AddRuleCommand}" Style="{StaticResource SecondaryButtonStyle}" Margin="0,0,8,0"/>
                                    <Button Content="删除所选" Command="{Binding RemoveSelectedRuleCommand}" Style="{StaticResource SecondaryButtonStyle}"/>
                                    <Button Content="保存设置" Command="{Binding SaveSettingsCommand}" Style="{StaticResource PrimaryButtonStyle}" Margin="8,0,0,0"/>
                                </StackPanel>
                                                                <DataGrid x:Name="RulesGrid" Grid.Row="1" ItemsSource="{Binding ApplicationRules}" SelectedItem="{Binding SelectedRule, Mode=TwoWay}"
                                                                          AutoGenerateColumns="False" CanUserAddRows="False" HeadersVisibility="Column"
                                                                          Margin="0,0,0,8" IsReadOnly="False" BeginningEdit="RulesGrid_BeginningEdit"
                                                                          ToolTipService.ShowOnDisabled="True"
                                                                          ToolTipService.InitialShowDelay="300"
                                                                          ToolTipService.ShowDuration="60000">
                                    <DataGrid.Columns>
                                                                        <DataGridCheckBoxColumn Binding="{Binding Enabled}" Width="60">
                                                                            <DataGridCheckBoxColumn.Header>
                                                                                <TextBlock Text="启用" ToolTip="是否启用该规则的监控与阈值判定。"/>
                                                                            </DataGridCheckBoxColumn.Header>
                                                                            <DataGridCheckBoxColumn.ElementStyle>
                                                                                <Style TargetType="CheckBox">
                                                                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                                                                    <Setter Property="ToolTip" Value="是否启用该规则的监控与阈值判定。"/>
                                                                                </Style>
                                                                            </DataGridCheckBoxColumn.ElementStyle>
                                                                        </DataGridCheckBoxColumn>
                                                                        <DataGridTemplateColumn Width="150">
                                                                            <DataGridTemplateColumn.Header>
                                                                                <TextBlock Text="名称" ToolTip="仅用于显示的名称，不参与匹配，可自定义。"/>
                                                                            </DataGridTemplateColumn.Header>
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding DisplayName}" ToolTip="仅用于显示的名称，不参与匹配，可自定义。"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                            <DataGridTemplateColumn.CellEditingTemplate>
                                                <DataTemplate>
                                                    <TextBox Text="{Binding DisplayName, UpdateSourceTrigger=PropertyChanged}"
                                                             ToolTip="仅用于显示的名称，不参与匹配，可自定义。"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellEditingTemplate>
                                                                            <DataGridTemplateColumn.CellStyle>
                                                                                <Style TargetType="DataGridCell">
                                                                                    <Setter Property="ToolTip" Value="仅用于显示的名称，不参与匹配，可自定义。"/>
                                                                                </Style>
                                                                            </DataGridTemplateColumn.CellStyle>
                                        </DataGridTemplateColumn>
                                                                        <DataGridTemplateColumn Width="120">
                                                                            <DataGridTemplateColumn.Header>
                                                                                <TextBlock Text="进程名" ToolTip="进程名（不含 .exe）。用于匹配系统进程，例如 chrome、msedge。"/>
                                                                            </DataGridTemplateColumn.Header>
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding ProcessName}" ToolTip="进程名（不含 .exe）。用于匹配系统进程，例如 chrome、msedge。"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                            <DataGridTemplateColumn.CellEditingTemplate>
                                                <DataTemplate>
                                                    <TextBox Text="{Binding ProcessName, UpdateSourceTrigger=PropertyChanged}"
                                                             ToolTip="进程名（不含 .exe）。用于匹配系统进程，例如 chrome、msedge。"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellEditingTemplate>
                                                                            <DataGridTemplateColumn.CellStyle>
                                                                                <Style TargetType="DataGridCell">
                                                                                    <Setter Property="ToolTip" Value="进程名（不含 .exe）。用于匹配系统进程，例如 chrome、msedge。"/>
                                                                                </Style>
                                                                            </DataGridTemplateColumn.CellStyle>
                                        </DataGridTemplateColumn>
                                                                        <DataGridTemplateColumn Width="*">
                                                                            <DataGridTemplateColumn.Header>
                                                                                <TextBlock Text="可执行路径" ToolTip="可选：目标程序的完整路径，用于更精确匹配和显示图标。留空则仅按进程名匹配。"/>
                                                                            </DataGridTemplateColumn.Header>
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding ExecutablePath}" TextTrimming="CharacterEllipsis"
                                                               ToolTip="可选：目标程序的完整路径，用于更精确匹配和显示图标。留空则仅按进程名匹配。"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                            <DataGridTemplateColumn.CellEditingTemplate>
                                                <DataTemplate>
                                                    <TextBox Text="{Binding ExecutablePath, UpdateSourceTrigger=PropertyChanged}"
                                                             ToolTip="可选：目标程序的完整路径，用于更精确匹配和显示图标。留空则仅按进程名匹配。"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellEditingTemplate>
                                                                            <DataGridTemplateColumn.CellStyle>
                                                                                <Style TargetType="DataGridCell">
                                                                                    <Setter Property="ToolTip" Value="可选：目标程序的完整路径，用于更精确匹配和显示图标。留空则仅按进程名匹配。"/>
                                                                                </Style>
                                                                            </DataGridTemplateColumn.CellStyle>
                                        </DataGridTemplateColumn>
                                                                        <DataGridTemplateColumn Width="100">
                                                                            <DataGridTemplateColumn.Header>
                                                                                <TextBlock Text="用全局阈值" ToolTip="勾选后使用全局阈值，行内覆写值将被忽略且不可编辑。"/>
                                                                            </DataGridTemplateColumn.Header>
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <CheckBox IsChecked="{Binding UseGlobalThresholds}"
                                                              HorizontalAlignment="Center"
                                                              ToolTip="勾选后使用全局阈值，行内覆写值将被忽略且不可编辑。"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                            <DataGridTemplateColumn.CellEditingTemplate>
                                                <DataTemplate>
                                                    <CheckBox IsChecked="{Binding UseGlobalThresholds}"
                                                              HorizontalAlignment="Center"
                                                              ToolTip="勾选后使用全局阈值，行内覆写值将被忽略且不可编辑。"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellEditingTemplate>
                                                                            <DataGridTemplateColumn.CellStyle>
                                                                                <Style TargetType="DataGridCell">
                                                                                    <Setter Property="ToolTip" Value="勾选后使用全局阈值，行内覆写值将被忽略且不可编辑。"/>
                                                                                </Style>
                                                                            </DataGridTemplateColumn.CellStyle>
                                        </DataGridTemplateColumn>
                                                                                <DataGridTemplateColumn Width="90">
                                                                                    <DataGridTemplateColumn.Header>
                                                                                        <TextBlock Text="CPU% (覆写)" ToolTip="该规则下所有匹配进程的 CPU 使用率总和阈值（%）。"/>
                                                                                    </DataGridTemplateColumn.Header>
                                                                                    <DataGridTemplateColumn.CellTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBlock x:Name="tbCpu" Text="{Binding Thresholds.CpuPct}"
                                                                                                       ToolTip="该规则下所有匹配进程的 CPU 使用率总和。超过此百分比并持续达到‘持续秒数’将触发关闭。"/>
                                                                                            <DataTemplate.Triggers>
                                                                                                <DataTrigger Binding="{Binding UseGlobalThresholds}" Value="True">
                                                                                                    <Setter TargetName="tbCpu" Property="Foreground" Value="Gray"/>
                                                                                                </DataTrigger>
                                                                                            </DataTemplate.Triggers>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellTemplate>
                                                                                    <DataGridTemplateColumn.CellEditingTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBox Text="{Binding Thresholds.CpuPct, UpdateSourceTrigger=PropertyChanged}"
                                                                                                     IsEnabled="{Binding UseGlobalThresholds, Converter={StaticResource InverseBooleanConverter}}"
                                                                                                     ToolTip="该规则下所有匹配进程的 CPU 使用率总和。超过此百分比并持续达到‘持续秒数’将触发关闭。"/>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellEditingTemplate>
                                                                                    <DataGridTemplateColumn.CellStyle>
                                                                                        <Style TargetType="DataGridCell">
                                                                                            <Setter Property="ToolTip" Value="该规则下所有匹配进程的 CPU 使用率总和。超过此百分比并持续达到‘持续秒数’将触发关闭。"/>
                                                                                        </Style>
                                                                                    </DataGridTemplateColumn.CellStyle>
                                                                                </DataGridTemplateColumn>
                                                                                <DataGridTemplateColumn Width="110">
                                                                                    <DataGridTemplateColumn.Header>
                                                                                        <TextBlock Text="内存MB (覆写)" ToolTip="该规则下所有匹配进程的工作集（物理内存）阈值（MB）。"/>
                                                                                    </DataGridTemplateColumn.Header>
                                                                                    <DataGridTemplateColumn.CellTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBlock x:Name="tbMem" Text="{Binding Thresholds.MemoryMB}"
                                                                                                       ToolTip="该规则下所有匹配进程的工作集（物理内存）总和。单位：MB。"/>
                                                                                            <DataTemplate.Triggers>
                                                                                                <DataTrigger Binding="{Binding UseGlobalThresholds}" Value="True">
                                                                                                    <Setter TargetName="tbMem" Property="Foreground" Value="Gray"/>
                                                                                                </DataTrigger>
                                                                                            </DataTemplate.Triggers>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellTemplate>
                                                                                    <DataGridTemplateColumn.CellEditingTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBox Text="{Binding Thresholds.MemoryMB, UpdateSourceTrigger=PropertyChanged}"
                                                                                                     IsEnabled="{Binding UseGlobalThresholds, Converter={StaticResource InverseBooleanConverter}}"
                                                                                                     ToolTip="该规则下所有匹配进程的工作集（物理内存）总和。单位：MB。"/>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellEditingTemplate>
                                                                                    <DataGridTemplateColumn.CellStyle>
                                                                                        <Style TargetType="DataGridCell">
                                                                                            <Setter Property="ToolTip" Value="该规则下所有匹配进程的工作集（物理内存）总和。单位：MB。"/>
                                                                                        </Style>
                                                                                    </DataGridTemplateColumn.CellStyle>
                                                                                </DataGridTemplateColumn>
                                                                                <DataGridTemplateColumn Width="120">
                                                                                    <DataGridTemplateColumn.Header>
                                                                                        <TextBlock Text="磁盘B/s (覆写)" ToolTip="按每秒 I/O 读写字节数近似磁盘吞吐量阈值（Byte/s）。"/>
                                                                                    </DataGridTemplateColumn.Header>
                                                                                    <DataGridTemplateColumn.CellTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBlock x:Name="tbDisk" Text="{Binding Thresholds.DiskBytesPerSec}"
                                                                                                       ToolTip="按每秒 I/O 读写字节数近似磁盘吞吐量（包含部分非磁盘 I/O）。单位：Byte/s。"/>
                                                                                            <DataTemplate.Triggers>
                                                                                                <DataTrigger Binding="{Binding UseGlobalThresholds}" Value="True">
                                                                                                    <Setter TargetName="tbDisk" Property="Foreground" Value="Gray"/>
                                                                                                </DataTrigger>
                                                                                            </DataTemplate.Triggers>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellTemplate>
                                                                                    <DataGridTemplateColumn.CellEditingTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBox Text="{Binding Thresholds.DiskBytesPerSec, UpdateSourceTrigger=PropertyChanged}"
                                                                                                     IsEnabled="{Binding UseGlobalThresholds, Converter={StaticResource InverseBooleanConverter}}"
                                                                                                     ToolTip="按每秒 I/O 读写字节数近似磁盘吞吐量（包含部分非磁盘 I/O）。单位：Byte/s。"/>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellEditingTemplate>
                                                                                    <DataGridTemplateColumn.CellStyle>
                                                                                        <Style TargetType="DataGridCell">
                                                                                            <Setter Property="ToolTip" Value="按每秒 I/O 读写字节数近似磁盘吞吐量（包含部分非磁盘 I/O）。单位：Byte/s。"/>
                                                                                        </Style>
                                                                                    </DataGridTemplateColumn.CellStyle>
                                                                                </DataGridTemplateColumn>
                                                                                <DataGridTemplateColumn Width="100">
                                                                                    <DataGridTemplateColumn.Header>
                                                                                        <TextBlock Text="GPU% (覆写)" ToolTip="基于 GPU Engine 的近似 GPU 使用率阈值（%）。"/>
                                                                                    </DataGridTemplateColumn.Header>
                                                                                    <DataGridTemplateColumn.CellTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBlock x:Name="tbGpu" Text="{Binding Thresholds.GpuPct}"
                                                                                                       ToolTip="基于 GPU Engine 计数器的近似 GPU 使用率总和。单位：%。"/>
                                                                                            <DataTemplate.Triggers>
                                                                                                <DataTrigger Binding="{Binding UseGlobalThresholds}" Value="True">
                                                                                                    <Setter TargetName="tbGpu" Property="Foreground" Value="Gray"/>
                                                                                                </DataTrigger>
                                                                                            </DataTemplate.Triggers>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellTemplate>
                                                                                    <DataGridTemplateColumn.CellEditingTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBox Text="{Binding Thresholds.GpuPct, UpdateSourceTrigger=PropertyChanged}"
                                                                                                     IsEnabled="{Binding UseGlobalThresholds, Converter={StaticResource InverseBooleanConverter}}"
                                                                                                     ToolTip="基于 GPU Engine 计数器的近似 GPU 使用率总和。单位：%。"/>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellEditingTemplate>
                                                                                    <DataGridTemplateColumn.CellStyle>
                                                                                        <Style TargetType="DataGridCell">
                                                                                            <Setter Property="ToolTip" Value="基于 GPU Engine 计数器的近似 GPU 使用率总和。单位：%。"/>
                                                                                        </Style>
                                                                                    </DataGridTemplateColumn.CellStyle>
                                                                                </DataGridTemplateColumn>
                                                                                <DataGridTemplateColumn Width="120">
                                                                                    <DataGridTemplateColumn.Header>
                                                                                        <TextBlock Text="网络B/s (覆写)" ToolTip="按每秒 IO Other Bytes 近似网络吞吐阈值（Byte/s）。"/>
                                                                                    </DataGridTemplateColumn.Header>
                                                                                    <DataGridTemplateColumn.CellTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBlock x:Name="tbNet" Text="{Binding Thresholds.NetBytesPerSec}"
                                                                                                       ToolTip="按每秒 IO Other Bytes 近似网络吞吐量（可能含其他开销）。单位：Byte/s。"/>
                                                                                            <DataTemplate.Triggers>
                                                                                                <DataTrigger Binding="{Binding UseGlobalThresholds}" Value="True">
                                                                                                    <Setter TargetName="tbNet" Property="Foreground" Value="Gray"/>
                                                                                                </DataTrigger>
                                                                                            </DataTemplate.Triggers>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellTemplate>
                                                                                    <DataGridTemplateColumn.CellEditingTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBox Text="{Binding Thresholds.NetBytesPerSec, UpdateSourceTrigger=PropertyChanged}"
                                                                                                     IsEnabled="{Binding UseGlobalThresholds, Converter={StaticResource InverseBooleanConverter}}"
                                                                                                     ToolTip="按每秒 IO Other Bytes 近似网络吞吐量（可能含其他开销）。单位：Byte/s。"/>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellEditingTemplate>
                                                                                    <DataGridTemplateColumn.CellStyle>
                                                                                        <Style TargetType="DataGridCell">
                                                                                            <Setter Property="ToolTip" Value="按每秒 IO Other Bytes 近似网络吞吐量（可能含其他开销）。单位：Byte/s。"/>
                                                                                        </Style>
                                                                                    </DataGridTemplateColumn.CellStyle>
                                                                                </DataGridTemplateColumn>
                                                                                <DataGridTemplateColumn Width="110">
                                                                                    <DataGridTemplateColumn.Header>
                                                                                        <TextBlock Text="持续秒数 (覆写)" ToolTip="超过任意阈值后需要持续多久才执行关闭（秒）。0 表示立即关闭。"/>
                                                                                    </DataGridTemplateColumn.Header>
                                                                                    <DataGridTemplateColumn.CellTemplate>
                                                                                        <DataTemplate>
                                                                                            <TextBlock x:Name="tbSustain" Text="{Binding Thresholds.SustainSeconds}"
                                                                                                       ToolTip="阈值被超过后需要持续多久才执行关闭。0 表示立即关闭。单位：秒。"/>
                                                                                            <DataTemplate.Triggers>
                                                                                                <DataTrigger Binding="{Binding UseGlobalThresholds}" Value="True">
                                                                                                    <Setter TargetName="tbSustain" Property="Foreground" Value="Gray"/>
                                                                                                </DataTrigger>
                                                                                            </DataTemplate.Triggers>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellTemplate>
                                                                                    <DataGridTemplateColumn.CellEditingTemplate>
                                                                                        <DataTemplate>
                                                                                             <TextBox Text="{Binding Thresholds.SustainSeconds, UpdateSourceTrigger=PropertyChanged}"
                                                                                                      IsEnabled="{Binding UseGlobalThresholds, Converter={StaticResource InverseBooleanConverter}}"
                                                                                                      ToolTip="阈值被超过后需要持续多久才执行关闭。0 表示立即关闭。单位：秒。"/>
                                                                                        </DataTemplate>
                                                                                    </DataGridTemplateColumn.CellEditingTemplate>
                                                                                    <DataGridTemplateColumn.CellStyle>
                                                                                        <Style TargetType="DataGridCell">
                                                                                            <Setter Property="ToolTip" Value="阈值被超过后需要持续多久才执行关闭。0 表示立即关闭。单位：秒。"/>
                                                                                        </Style>
                                                                                    </DataGridTemplateColumn.CellStyle>
                                                                                </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                                <GroupBox Grid.Row="2" Header="全局阈值" Margin="0,8,0,0">
                                    <StackPanel Orientation="Horizontal" Margin="8">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                            <TextBlock Text="CPU%:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Text="{Binding GlobalThresholds.CpuPct}" Width="60"
                                                     ToolTip="全局默认：所有规则在‘用全局阈值’为真时使用。表示匹配进程 CPU 使用率总和的阈值（%）。"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                            <TextBlock Text="内存MB:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Text="{Binding GlobalThresholds.MemoryMB}" Width="80"
                                                     ToolTip="全局默认：匹配进程工作集（物理内存）总和的阈值（MB）。"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                            <TextBlock Text="磁盘B/s:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Text="{Binding GlobalThresholds.DiskBytesPerSec}" Width="120"
                                                     ToolTip="全局默认：按每秒 I/O 读写字节数近似磁盘吞吐量（包含部分非磁盘 I/O）。单位：Byte/s。"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                            <TextBlock Text="GPU%:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Text="{Binding GlobalThresholds.GpuPct}" Width="60"
                                                     ToolTip="全局默认：基于 GPU Engine 计数器的近似 GPU 使用率阈值（%）。"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                            <TextBlock Text="网络B/s:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Text="{Binding GlobalThresholds.NetBytesPerSec}" Width="120"
                                                     ToolTip="全局默认：按每秒 IO Other Bytes 近似网络吞吐量（可能含其他开销）。单位：Byte/s。"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                            <TextBlock Text="持续秒数:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Text="{Binding GlobalThresholds.SustainSeconds}" Width="80"
                                                     ToolTip="全局默认：阈值被超过后需要持续多久才执行关闭。0 表示立即关闭。单位：秒。"/>
                                        </StackPanel>
                                    </StackPanel>
                                </GroupBox>
                            </Grid>
                        </TabItem>
                    </TabControl>
                </Grid>
            </Border>
        </Grid>
        
        <!-- 状态栏 -->
        <StatusBar Grid.Row="2" Style="{StaticResource StatusBarStyle}">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <TextBlock Text="{Binding CurrentTime, StringFormat='yyyy-MM-dd HH:mm:ss'}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
